<!DOCTYPE html>
<html lang="pt">
    <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="theme-color" content="#00aeef" />
  <meta http-equiv="Content-Language" content="pt" />

  <!-- Enable responsiveness on mobile devices-->
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1"
  />

  <title>
     POS Integrado &middot; Documentações e tutoriais 
  </title>

  <link rel="shortcut icon" href="https://developercielo.github.io/assets/favicon.ico" />

  <!-- CSS -->
  <link
    href="https://fonts.googleapis.com/css?family=Fira+Sans:300,400,500"
    rel="stylesheet"
    media="none"
    onload="if(media!='all')media='all'"
  />
  <script async src="https://use.fontawesome.com/3ae06f1030.js"></script>

  <link
    rel="stylesheet"
    href="https://developercielo.github.io/assets/bundles/css/bundle.min.css"
  />

   
  <link
    rel="alternate"
    hreflang="pt"
    href="https://developercielo.github.io/manual/cielo-pos"
  />
    
  <link
    rel="alternate"
    hreflang="en"
    href="https://developercielo.github.io/en/manual/cielo-pos"
  />
   

  <!-- RSS -->
  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS"
    href="https://developercielo.github.io/atom.xml"
  />
</head>

    <body>
        
        <div class="content-container">
            <div class="language-tabs">
                <a class='hide-btn' id="hide-button" title="Comutar"><i class="fa fa-bars" aria-hidden="true"></i></a>
                <ul class="language-buttons">
                    
                    <li><a data-language-name='shell'>cURL</a></li>
                    
                </ul>
            </div>
            <div class="dark-box"></div>
            <div class="overlay"></div>
        
            <div id="submenu">
                <div class="submenu-container">
                    <div class="submenu-row sub-items">
                        <div class="submenu-itens">
                            <a href="https://devcielo.zendesk.com/hc/pt-br#suporte" class="help">Ajuda</a>

                            
                        </div>

                        
                        <div class="search">
                            <input type="text" class="search" id="input-search">
                        </div>
                    </div>
                    <div class="submenu-row results">
                        <div class="search-results-container">
                            <ul class="search-results"></ul>
                        </div>
                    </div>
                        

                    <div class="submenu-row breads">
                        <ol class="breadcrumb">
                            
                            <li><a href="/">Início</a></li>
                            
                            
                            
                            
                                
                                    
                                    
                                    
                                    
                                    
                                        
                                    
                                        
                                    
                                        
                                    
                                
                            
                                
                                    
                                    <li class="active">&gt; <a href="https://developercielo.github.io/manual/cielo-pos">POS Integrado</a></li>
                                    
                                
                            
                        </ol>
                    </div>
                </div>
            </div>

            <div class="post"><h1 id="introdução">Introdução</h1>

<p>Este documento destina-se a especificar o processo de integração entre um terminal de pagamento Cielo (“POS”) e um sistema de checkout, de forma a se poder cumprir exigências legais de alguns estados brasileiros.</p>

<p>Por “checkout” entende-se um conjunto de hardware e software responsável por gerir o processo de venda de bens ou serviços em um estabelecimento através de um sistema de Automação Comercial, incluindo os processos de registro fiscal exigidos pelo governo (por exemplo, impressão de comprovante em uma impressora fiscal ou geração de Nota Fiscal Eletrônica).</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.002.png" alt="" /></p>

<p>Esta especificação define uma forma de trabalho diferenciada para o POS Cielo denominada <strong>“Modo Integrado”</strong>, de forma a cumprir as seguintes premissas:</p>

<ul>
  <li>O POS recebe o valor do <em>checkout</em> para efetuar a transação de pagamento, seja com cartão ou via Pix.</li>
  <li>O POS não imprime o comprovante, devolvendo suas informações para que o <em>checkout</em> efetue os processos ficais.</li>
</ul>

<p>Os capítulos a seguir descrevem de forma detalhada como o <strong>Modo Integrado</strong> funciona e quais são as informações trocadas entre os dois sistemas.</p>

<p>Alternativamente, sistemas de checkout que têm implementado o processo de troca de
arquivos definido para o antigo “Gerenciador Padrão TEF Discado” podem utilizar uma
aplicação MS/Windows distribuída pela Cielo conforme descrito no Capítulo 4, dispensando a
implementação especificada neste documento.</p>

<blockquote>
  <p>Alternativamente, sistemas de checkout que têm implementado o processo de troca de arquivos definido para o antigo “Gerenciador Padrão TEF Discado” podem utilizar uma aplicação MS/Windows distribuída pela Cielo conforme descrito no Capítulo 4, dispensando a implementação especificada neste documento.</p>
</blockquote>

<h2 id="referências">Referências</h2>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc8259">RFC 8259: The JavaScript Object Notation (JSON) Data Interchange Format (2017)</a></li>
  <li>ISO/IEC 21778: Information technology - The JSON data interchange syntax (2017)</li>
  <li>TEF_DIAL: Guia Técnico da Solução TEF Discado - Versão 2.5 - março/2010 (ou versão superior)</li>
</ul>

<h2 id="formatos-usados-neste-documento">Formatos usados neste documento</h2>

<p>Este documento menciona diversos dados em funções e tabelas, sendo que estes dados, por suas características, devem respeitar diferentes regras de codificação.</p>

<p>A representação de um formato segue a seguinte regra: <strong>“[Caractere de Formato][..][Tamanho]”</strong></p>

<p><strong>[Caractere de Formato]</strong> = Letra maiúscula que define o formato.</p>

<p><strong>[..]</strong> = Opcional, indica que o dado é de tamanho variável, podendo ter de zero a <strong>[Tamanho]</strong> bytes.
[Tamanho] = De um a quatro dígitos numéricos representando a quantidade de bytes utilizada pela informação, ou “var” para indicar tamanho indefinido.</p>

<p>Exemplos:</p>
<ul>
  <li>O código <code class="language-plaintext highlighter-rouge">A256</code> indica uma informação de 256 bytes codificada de acordo com o formato “A”.</li>
  <li>O código <code class="language-plaintext highlighter-rouge">N..99</code> indica uma informação de tamanho variável (de 0 a 99 bytes) codificada de acordo com o formato “N”.</li>
  <li>O código <code class="language-plaintext highlighter-rouge">A..var</code> indica uma informação de tamanho variável codificada de acordo com o formato “A”.</li>
</ul>

<p>A tabela seguir detalha os formatos adotados neste documento:</p>

<table>
  <tbody>
    <tr>
      <td><strong>Formato</strong></td>
      <td><strong>Descrição</strong></td>
    </tr>
    <tr>
      <td><strong>A</strong></td>
      <td>Alfanumérico codificado segundo tabela ASCII, podendo conter bytes de 20h (espaço) a 7Eh (~). Quando a informação for menor do que o campo definido, ela deverá ser alinhada à esquerda com espaços (20h) à direita.Exemplo: Se um campo de formato “A6” contém a informação “TEXTO”, ele é codificado como: 54h 45h 58h 54h 4Fh 20h.</td>
    </tr>
    <tr>
      <td><strong>N</strong></td>
      <td>Numérico decimal codificado segundo a tabela ASCII, podendo conter somente bytes de 30h (“0”) a 39h (“9”). Quando a informação for menor do que o campo definido, ela deverá ser alinhada à direita com zeros (30h) à esquerda.Exemplo: Se um campo de formato “N8” contém a informação numérica 1234, ele é codificado como: 30h 30h 30h 30h 31h 32h 33h 34h.</td>
    </tr>
  </tbody>
</table>

<h1 id="visão-geral">Visão Geral</h1>

<h2 id="escopo">Escopo</h2>

<p>A solução definida neste documento se aplica a estabelecimentos com poucos checkouts. Paraestabelecimentos com muitos checkouts (um grande supermercado, por exemplo) recomenda-se o uso de soluções TEF com pinpads.</p>

<p>São premissas desta solução:</p>

<ul>
  <li>Um POS Cielo é configurado para operar em Modo Integrado com um único checkout, de forma exclusiva.</li>
  <li>É possível configurar mais de um POS Cielo para operar com um determinado checkout.</li>
</ul>

<p>O diagrama a seguir ilustra o exemplo de um estabelecimento com dois checkouts e três POS Cielo, sendo que os POS #1 e #2 operam com o checkout A, enquanto o POS #3 opera com o checkout B.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.003.png" alt="" /></p>

<h2 id="fluxo-simplificado">Fluxo simplificado</h2>

<p>O diagrama a seguir ilustra, de forma simplificada, o fluxo de comunicação entre o POS e o checkout.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.004.png" alt="" /></p>

<p>O <strong>Modo Integrado</strong> pressupõe que o POS e o checkout estejam em uma mesma rede local, sendo que o POS usa conexão via Wi-Fi.</p>

<p>A operação de pagamento segue o seguinte fluxo:</p>

<ol>
  <li>O checkout inicia um processo de pagamento via cartão (1), aguardando a conexão de um terminal POS da CIELO via Wi-Fi (TCP/IP).</li>
  <li>O lojista usa um POS da CIELO e inicia o pagamento via menu ou cartão (2), da mesma forma como é operado um POS autônomo. Este POS deve estar previamente configurado para comunicar com o checkout em questão (ver seção 2.3).</li>
  <li>Ao chegar na tela de captura do valor, o POS se conecta ao checkout (3) para receber essa informação que não poderá ser editada.</li>
  <li>Ao concluir a operação, o POS não imprime o comprovante e devolve os dados para o checkout (4), indicando sucesso ou fracasso, fornecendo também as informações para os procedimentos fiscais (ECF ou sistema de Nota Fiscal Eletrônica).</li>
  <li>O checkout efetua os procedimentos fiscais, imprimindo comprovante na ECF (5), por exemplo.</li>
  <li>Ao final, o checkout devolve uma confirmação para o POS (6), indicando se tudo correu bem ou se houve algum problema nos procedimentos fiscais ou outro erro fatal que implique na anulação da transação.</li>
</ol>

<h2 id="alterações-no-pos">Alterações no POS</h2>

<p>No <strong>“Modo Integrado”</strong>, o POS efetua todas as operações não financeiras da mesma forma que o POS convencional (inicialização, consultas, pré-autorização, reimpressão, relatórios, etc). Somente as transações financeiras (de pagamento) são afetadas neste modo.</p>

<p>O cadastro do POS na Cielo indica se ele opera em <strong>“Modo Integrado”</strong> ou de forma “convencional” (autônomo), sendo que isso não pode ser modificado manualmente no equipamento.</p>

<p>A aplicação do POS Cielo conta com as seguintes modificações quando opera em <strong>“Modo Integrado”:</strong></p>

<p>A aplicação do POS Cielo conta com as seguintes modificações quando opera em “Modo Integrado”:</p>

<ul>
  <li>Permite a configuração do endereço IP e porta da máquina onde está instalado o checkout.</li>
  <li>No momento da transação (seja com cartão, Pix, ou outro produto de pagamento da Cielo), o terminal efetua uma conexão via socket TCP com o checkout para receber o valor da transação, que não poderá ser alterado pelo operador.</li>
  <li>Ao final da transação, o terminal efetua uma nova conexão via socket TCP com o checkout para enviar o resultado da transação e outras informações, como a imagem do comprovante, número lógico, código de autorização, NSU, etc. Em seguida, na mesma conexão socket TCP, o terminal POS fica aguardando a confirmação do checkout para, em caso de erro, poder desfazer a transação efetuada.</li>
</ul>

<h1 id="comunicação">Comunicação</h1>

<p>Este capítulo apresenta em detalhes como é feita a comunicação entre o POS e o checkout.</p>

<h2 id="fluxo-detalhado">Fluxo detalhado</h2>

<p>O fluxo a seguir ilustra os processos envolvidos na comunicação entre as partes:</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.005.png" alt="" /></p>

<ol>
  <li>Ao finalizar o registro dos produtos sendo vendidos, o operador seleciona a opção “Pagamento em Cartão” no checkout. Neste momento, o checkout abre uma tela indicando “Aguardando POS Cielo…” e entra em modo de espera por uma conexão socket TCP/IP (“listen”).</li>
  <li>O operador inicia uma transação de pagamento no POS. Ao invés de solicitar o valor, o POS efetua uma conexão socket TCP com o checkout (“connect”).</li>
  <li>O POS envia ao checkout uma mensagem de “início de sessão” e este devolve algumas informações úteis, como o valor a ser pago.</li>
  <li>O POS poderá desconectar o socket TCP para liberar recursos (“closesocket”). O checkout apresenta uma mensagem de “Aguardando autorização…” e volta a ficar em modo “listen”, aguardando nova conexão socket TCP.</li>
  <li>O POS se conecta à Cielo para efetuar a autorização financeira.</li>
  <li>Independentemente do resultado da autorização (sucesso ou falha), o POS efetua uma nova conexão socket TCP com o checkout (“connect”), se necessário, e envia o resultado da autorização em uma mensagem de “fim de sessão”.</li>
  <li>Se a transação financeira for aprovada, o checkout efetua os procedimentos fiscais exigidos pelo governo e devolve uma resposta ao POS indicando se estes foram bem-sucedidos.</li>
  <li>O POS desconecta o socket TCP para liberar recursos (“closesocket”). Se a transação foi aprovada na Cielo, mas o checkout indicou falha nos procedimentos fiscais, o POS marca</li>
</ol>

<p><strong>Observações:</strong></p>

<ul>
  <li>Quem efetua a conexão e a desconexão do socket TCP/IP é sempre o POS, sendo que o checkout assume um comportamento passivo a esse respeito.</li>
  <li>O processo pode ser cancelado no checkout a qualquer momento pelo operador. Neste caso, o checkout fecha o socket e deixa de aguardar conexões vindas dos POS.</li>
  <li>Caso o checkout receba uma mensagem inconsistente do POS, ele fecha o socket e volta a esperar por uma nova conexão do POS (ver detalhamento na seção 3.4).</li>
  <li>O tempo máximo de espera para conexão socket (“connect”) é de 5 (cinco) segundos. O POS deve tentar a conexão até 6 (seis) vezes, totalizando 30 (trinta) segundos.</li>
  <li>O tempo máximo de espera pela resposta de início de sessão é de 3 (três) segundos.</li>
  <li>O tempo máximo de espera pela resposta de finalização de sessão é de 60 (sessenta) segundos.</li>
</ul>

<h2 id="formato-das-mensagens">Formato das mensagens</h2>

<p>As mensagens trocadas entre o POS e checkout utilizam o formato JSON. Além disso, para evitar fragmentação por conta da rede TCP/IP, as mensagens devem ser encabeçadas por dois bytes que indicam o tamanho.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.006.png" alt="" /></p>

<p>Ao receber uma mensagem via <em>socket</em>, o receptor deve conferir os bytes de tamanho e, se estes indicarem uma quantidade de bytes maior do que foi recebido, isso indica que houve fragmentação. Neste caso, deve-se buscar mais bytes na camada TCP/IP até que a mensagem esteja completa.</p>

<blockquote>
  <p>O tempo máximo de espera por um fragmento de mensagem é de 1 (um) segundo.</p>
</blockquote>

<p><strong>Corpo da mensagem (JSON):</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdInitSession"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Bytes trafegados</strong></p>

<p>00 49 7B 93 6D 73 67 5F 69 64 94 3A
20 93 43 6D 64 49 6E 69 74 53 65 73
73 69 6F 6E 94 2C 20 93 70 6F 73 5F
69 64 94 3A 20 93 39 31 37 34 36 32
34 31 94 2C 20 93 73 65 71 5F 70 6F
73 94 3A 20 93 30 30 30 31 38 37 32
35 94 7D</p>

<h2 id="comandos-e-respostas">Comandos e Respostas</h2>

<p>Esta seção define o formato das mensagens trocadas entre o POS e o checkout.</p>

<p>Observações</p>

<ul>
  <li>A coluna “Presença” das tabelas desta seção indica se um campo deve ou não existir, usando a seguinte codificação:</li>
  <li><strong>M</strong>: Campo é mandatório, deve ocasionar erro se não for recebido.</li>
  <li><strong>O</strong>: Campo é opcional, a condição pela qual existe está informada na coluna “Descrição”.</li>
  <li><strong>MO</strong>: Campo é mandatório dentro de um objeto, mas o objeto é opcional.</li>
</ul>

<h3 id="início-de-sessão">Início de sessão</h3>

<p>Este comando é enviado pelo POS ao checkout para iniciar um processo de pagamento. Neste momento, o operador já deve ter selecionado a opção de “pagamento com cartão” no checkout, que fica em estado de espera para iniciar a sessão.</p>

<p>Na resposta a este comando, o checkout devolve o valor que será usado na transação, sendo que ele não poderá ser editado pelo operador do POS.</p>

<p><strong>Comando</strong></p>

<table>
  <thead>
    <tr>
      <th>Campo</th>
      <th>Tipo</th>
      <th>Formato</th>
      <th>Presença</th>
      <th>Descrição</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">msg_id</code></td>
      <td>string</td>
      <td>A..20</td>
      <td>M</td>
      <td>Identificação do comando: “CmdInitSession”.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pos_id</code></td>
      <td>string</td>
      <td>A8</td>
      <td>M</td>
      <td>Código do POS na rede Cielo.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seq_pos</code></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo POS.</td>
    </tr>
  </tbody>
</table>

<p>Observações</p>

<ul>
  <li>Para reforçar a integridade da comunicação entre o POS e o checkout, o POS gera um número sequencial (<code class="language-plaintext highlighter-rouge">seq_pos</code>) que deve ser devolvido pelo checkout na resposta.</li>
  <li>O checkout deve esperar por este comando por tempo indeterminado. O sistema deve, entretanto, disponibilizar uma forma para que o operador possa cancelar o processo enquanto o checkout aguarda o início da sessão (mais detalhes na seção 3.4).</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Campo</strong></th>
      <th><strong>Tipo</strong></th>
      <th><strong>Formato</strong></th>
      <th><strong>Presença</strong></th>
      <th><strong>Descrição</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">msg_id</code></strong></td>
      <td>string</td>
      <td>A..20</td>
      <td>M</td>
      <td>Identificação da resposta: <strong>RspInitSession</strong>.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">pos_id</code></strong></td>
      <td>string</td>
      <td>A8</td>
      <td>M</td>
      <td>Código do POS na rede Cielo.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">seq_pos</code></strong></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo POS.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">status</code></strong></td>
      <td>number</td>
      <td>N..2</td>
      <td>M</td>
      <td><strong>0</strong> → O checkout iniciou a sessão com sucesso;<br /><strong>1</strong> → Parâmetro passado é inválido;<br /><strong>2</strong> → Parâmetro mandatório não foi recebido;<br /><strong>3</strong> → Operação cancelada pelo operador;<br /><strong>10</strong> → Processo de pagamento não foi iniciado no checkout pelo operador;<br /><strong>11</strong> → O checkout está ocupado atendendo outro terminal;<br /><strong>99</strong> → Outro erro.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">seq_ac</code></strong></td>
      <td>string</td>
      <td>N8</td>
      <td>O</td>
      <td>Número sequencial da sessão gerado pelo checkout (só é devolvido em caso de sucesso).</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">transaction</code></strong></td>
      <td>object</td>
      <td>–</td>
      <td>O</td>
      <td>Parâmetros da transação a ser efetuada no POS (só é devolvido em caso de sucesso).</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">transaction.amount</code></strong></td>
      <td>string</td>
      <td>N..12</td>
      <td>O</td>
      <td>Valor da transação, inteiro em centavos.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">last_endsession</code></strong></td>
      <td>object</td>
      <td>–</td>
      <td>O</td>
      <td>Dados da última resposta <a href="#rspendsession"><strong>RspEndSession</strong></a> devolvida para este POS em uma sessão anterior.<br />Se for a primeira sessão deste POS com este checkout, este objeto não é devolvido.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">.seq_pos</code></strong></td>
      <td>string</td>
      <td>N8</td>
      <td>MO</td>
      <td>Número sequencial gerado pelo POS para a sessão referida.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">.seq_ac</code></strong></td>
      <td>string</td>
      <td>N8</td>
      <td>MO</td>
      <td>Número sequencial gerado pelo checkout para a sessão referida.</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">.status</code></strong></td>
      <td>number</td>
      <td>N..2</td>
      <td>MO</td>
      <td>Status devolvido pelo checkout ao finalizar a sessão referida.</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p><strong>Observações:</strong></p>

<ul>
  <li>Ao receber a resposta, o POS deve conferir <code class="language-plaintext highlighter-rouge">pos_id</code> e <code class="language-plaintext highlighter-rouge">seq_pos</code> e, caso estejam diferentes, a operação deve ser finalizada com erro.</li>
  <li>O checkout devolve o resultado da última sessão efetuada pelo POS. Isso serve para garantir que o POS acerte suas pendências caso ele não tenha recebido a <code class="language-plaintext highlighter-rouge">RspEndSession</code> da transação anterior.</li>
  <li>O POS deve esperar a resposta do checkout por 3 (três) segundos. Se a resposta não for recebida neste tempo, o POS aborta o processo com erro de “TEMPO ESGOTADO”.</li>
</ul>

<p><strong>Exemplo:</strong></p>

<p>O POS envia um comando para iniciar uma sessão.</p>

<p><strong>POS</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdInitSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O checkout aceita a conexão e informa o valor de R$ 125,80:</p>

<p><strong>AC</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RspInitSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"transaction"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12580"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_endsession"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018724"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000097"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="finalização-de-sessão">Finalização de sessão</h3>

<p>Este comando é enviado pelo POS ao checkout para indicar a conclusão do processo de pagamento, seja este bem ou malsucedido.</p>

<p>Em caso de sucesso, o POS envia uma série de informações referentes à transação efetuada, bem como imagens dos comprovantes que podem ser impressos pelo checkout.</p>

<p><strong>Comando</strong></p>

<table>
  <thead>
    <tr>
      <th>Campo</th>
      <th>Tipo</th>
      <th>Formato</th>
      <th>Presença</th>
      <th>Descrição</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">msg_id</code></td>
      <td>string</td>
      <td>A..20</td>
      <td>M</td>
      <td>Identificação do comando: <code class="language-plaintext highlighter-rouge">CmdEndSession</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pos_id</code></td>
      <td>string</td>
      <td>A8</td>
      <td>M</td>
      <td>Código do POS na rede Cielo.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seq_pos</code></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo POS.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seq_ac</code></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo checkout, devolvido em <code class="language-plaintext highlighter-rouge">RspInitSession</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">status</code></td>
      <td>number</td>
      <td>N..2</td>
      <td>M</td>
      <td>0 → Transação aprovada; 1 → Parâmetro passado é inválido; 2 → Parâmetro mandatório não foi recebido; 3 → Operação cancelada pelo operador; 20 → Problema de comunicação entre o POS e a rede Cielo; 21 → Transação negada pela rede Cielo; 99 → Outro erro.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">message</code></td>
      <td>string</td>
      <td>A..64</td>
      <td>O</td>
      <td>Mensagem opcional gerada pelo POS, seja de sucesso ou de falha.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pos_sn</code></td>
      <td>string</td>
      <td>A..32</td>
      <td>M</td>
      <td>Número de série do terminal.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">transaction</code></td>
      <td>object</td>
      <td>–</td>
      <td>O</td>
      <td>Dados da transação financeira autorizada pelo POS (este objeto só é devolvido se a transação for aprovada).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.amount</code></td>
      <td>string</td>
      <td>N..12</td>
      <td>MO</td>
      <td>Valor aprovado da transação, inteiro em centavos. <strong>IMPORTANTE:</strong> Este valor pode ser menor do que o solicitado pelo checkout no caso de aprovação parcial.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.prod_pri</code></td>
      <td>number</td>
      <td>N..4</td>
      <td>MO</td>
      <td>Código do produto matriz (tabela Cielo).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.prod_sec</code></td>
      <td>number</td>
      <td>N..4</td>
      <td>MO</td>
      <td>Código do produto secundário (tabela Cielo).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.installments</code></td>
      <td>number</td>
      <td>N..2</td>
      <td>O</td>
      <td>Número de parcelas, para o caso de transação parcelada.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.nsu</code></td>
      <td>string</td>
      <td>N6</td>
      <td>MO</td>
      <td>Número único gerado pelo POS para identificar a transação na rede Cielo.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.aut</code></td>
      <td>string</td>
      <td>N6</td>
      <td>O</td>
      <td>Código de autorização gerado pela rede Cielo (se cartão crédito/débito).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.timestamp</code></td>
      <td>string</td>
      <td>A19</td>
      <td>MO</td>
      <td>Data e hora da transação, no formato <code class="language-plaintext highlighter-rouge">aaaa-mm-ddThh:mm:ss</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.id_pix</code></td>
      <td>string</td>
      <td>A32</td>
      <td>O</td>
      <td>Identificador único da transação no Banco Central (somente para Pix).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.receipt_gen</code></td>
      <td>string array</td>
      <td>A..32</td>
      <td>MO</td>
      <td>Conjunto de strings correspondente ao comprovante da transação, via genérica que vale tanto para cliente quanto para o lojista (cada string representa uma linha).</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>Os códigos do produto (matriz e secundário) identificam o tipo de transação efetuada (por exemplo: cartão de crédito à vista, parcelado, cartão de débito, Pix, voucher, etc.) e não estão aqui especificados por serem dinâmicos e configuráveis nas tabelas do POS Cielo. Estas informações devem ser fornecidas pela Cielo em um documento à parte.</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th>Campo</th>
      <th>Tipo</th>
      <th>Formato</th>
      <th>Presença</th>
      <th>Descrição</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.receipt_cli</code></td>
      <td>string array</td>
      <td>A..32</td>
      <td>MO</td>
      <td>Conjunto de strings correspondente ao comprovante da transação, via do cliente (cada string representa uma linha do comprovante).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.receipt_cli_sm</code></td>
      <td>string array</td>
      <td>A..32</td>
      <td>MO</td>
      <td>Conjunto de strings correspondente ao comprovante da transação, via do cliente - comprovante reduzido (cada string representa uma linha do comprovante).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">.receipt_mch</code></td>
      <td>string array</td>
      <td>A..32</td>
      <td>MO</td>
      <td>Conjunto de strings correspondente ao comprovante da transação, via do lojista (cada string representa uma linha do comprovante).</td>
    </tr>
  </tbody>
</table>

<p><strong>Observações:</strong></p>

<ul>
  <li>O checkout deve esperar por este comando por tempo indeterminado. O sistema deve, entretanto, disponibilizar uma forma para que o operador possa cancelar o processo enquanto o checkout aguarda a finalização da sessão (mais detalhes na seção 3.4).</li>
</ul>

<p><strong>Resposta</strong></p>

<table>
  <thead>
    <tr>
      <th>Campo</th>
      <th>Tipo</th>
      <th>Formato</th>
      <th>Presença</th>
      <th>Descrição</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">msg_id</code></td>
      <td>string</td>
      <td>A..20</td>
      <td>M</td>
      <td>Identificação do comando: <code class="language-plaintext highlighter-rouge">RspEndSession</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pos_id</code></td>
      <td>string</td>
      <td>A8</td>
      <td>M</td>
      <td>Código do POS na rede Cielo.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seq_pos</code></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo POS.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seq_ac</code></td>
      <td>string</td>
      <td>N8</td>
      <td>M</td>
      <td>Número sequencial da sessão gerado pelo checkout, mesmo valor devolvido em <code class="language-plaintext highlighter-rouge">RspInitSession</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">status</code></td>
      <td>number</td>
      <td>N..2</td>
      <td>M</td>
      <td>0 → Sessão finalizada (procedimentos fiscais efetuados com sucesso no caso de transação autorizada);<br />1 → Parâmetro passado é inválido;<br />2 → Parâmetro mandatório não foi recebido;<br />3 → Operação cancelada pelo operador;<br />4 → Inconsistência em <code class="language-plaintext highlighter-rouge">seq_ac</code>;<br />12 → Erro ao efetuar os procedimentos fiscais (impressão de comprovante no ECF, por exemplo);<br />99 → Outro erro.<br /><strong>OBS:</strong> Se o status fornecido pelo POS em <code class="language-plaintext highlighter-rouge">CmdEndSession</code> for diferente de 0, o checkout deve replicar aqui o mesmo valor.</td>
    </tr>
  </tbody>
</table>

<p><strong>Observações:</strong></p>

<ul>
  <li>O checkout deve guardar os dados dessa resposta para envio numa próxima sessão que for estabelecida com o mesmo POS (ver <code class="language-plaintext highlighter-rouge">RspInitSession</code>).</li>
  <li>Ao receber a resposta, o POS deve conferir <code class="language-plaintext highlighter-rouge">pos_id</code> e <code class="language-plaintext highlighter-rouge">seq_pos</code> e, caso estejam diferentes, a mensagem deve ser ignorada. Se a transação foi aprovada, deve-se mantê-la pendente de confirmação até a próxima sessão, momento em que o checkout informa o que aconteceu de fato com a finalização da sessão.</li>
  <li>O POS deve esperar a resposta do checkout por 60 (sessenta) segundos. Se a resposta não for recebida neste tempo, o POS aborta o processo com erro de “TEMPO ESGOTADO”. Se a transação foi aprovada, deve-se mantê-la pendente de confirmação até a próxima sessão, momento em que o checkout informa o que aconteceu de fato com a finalização da sessão.</li>
  <li>Se a transação foi aprovada e o checkout responde com <code class="language-plaintext highlighter-rouge">status</code> diferente de 0 (zero), o POS deverá desfazer a transação.</li>
  <li>O POS sempre devolve as imagens dos comprovantes da transação. Cabe ao checkout imprimir ou não, de acordo com os desejos do lojista e do cliente.</li>
</ul>

<p><strong>Exemplo</strong></p>

<p>O POS envia um comando para finalizar a sessão, indicando sucesso na transação de pagamento.</p>

<p><strong>POS</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdEndSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_sn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"987264BY3463-23"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"transaction"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12580"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prod_pri"</span><span class="p">:</span><span class="w"> </span><span class="mi">1003</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prod_sec"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w">
        </span><span class="nl">"nsu"</span><span class="p">:</span><span class="w"> </span><span class="s2">"987654"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"aut"</span><span class="p">:</span><span class="w"> </span><span class="s2">"901782"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"installments"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-11-29T15:02:18"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"receipt_gen"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">" CIELO"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"29/11/2023 23:14:56"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"LOJAS DA CHINA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"RUA 25 DE MARCO, 123"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"SAO PAULO - SP"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"EC:000237236782351 POS:91746241"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"VALOR: 125,80"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"************6254 ONL-C"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"DOC:987654 AUT:901782"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">" AUTORIZADA COM SENHA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">" 446353-6254"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"A0000000031010-6FA837C30903A7D6"</span><span class="p">,</span><span class="w">
            </span><span class="s2">" CREDITO VISA"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_cli"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">" CIELO – VIA CLIENTE"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"29/11/2023 23:14:56"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"LOJAS DA CHINA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"RUA 25 DE MARCO, 123"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"SAO PAULO - SP"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"EC:000237236782351 POS:91746241"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"VALOR: 125,80"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"************6254 CREDITO VISA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"DOC:987654 AUT:901782"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_cli_sm"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"CIELO 29/11/2023 23:14:56"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"POS:91746241 ETB:000237236782351"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"VLR: 125,80 CREDITO VISA ***6254"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"DOC:987654 AUT:901782"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_mch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">" CIELO – VIA LOJA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"29/11/2023 23:14:56"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"LOJAS DA CHINA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"RUA 25 DE MARCO, 123"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"SAO PAULO - SP"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"EC:000237236782351 POS:91746241"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"VALOR: 125,80"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"************6254 ONL-C"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"DOC:987654 AUT:901782"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">" AUTORIZADA COM SENHA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">" 446353-6254"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"A0000000031010-6FA837C30903A7D6"</span><span class="p">,</span><span class="w">
            </span><span class="s2">" CREDITO VISA"</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O checkout recebe os dados da transação, efetua os procedimentos fiscais e retorna indicação de sucesso para o POS.</p>

<p><strong>AC</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RspEndSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="fluxo-de-comunicação-no-checkout">Fluxo de comunicação no checkout</h2>

<p><strong>Esta sessão detalha como o checkout deve tratar a comunicação TCP/IP com o POS, contemplando eventuais situações de erro.</strong></p>

<p>O checkout adota as seguintes premissas para trocar mensagens com o POS:</p>

<ul>
  <li>Caso o checkout receba uma mensagem inconsistente do POS (formato JSON inválido, mensagem incompleta, campos faltando, campo <code class="language-plaintext highlighter-rouge">seq_ac</code> inválido), ele deve fechar o socket e voltar a aguardar uma mensagem do POS.</li>
  <li>Caso o checkout receba uma mensagem incompleta do POS (verificado através dos dois bytes de tamanho no início), ele deverá aguardar os fragmentos restantes da mensagem por no máximo 1 (um) segundo cada um. Se esse tempo se esgotar, a mensagem recebida é considerada inconsistente e, portanto, descartada.</li>
  <li>O checkout deve permitir o cancelamento da operação pelo usuário. Se isso acontecer, o checkout deve fechar os sockets TCP/IP e voltar à tela de escolha da forma de pagamento.</li>
  <li>Se a operação ocorreu normalmente (do ponto de vista do protocolo de comunicação), seja um <code class="language-plaintext highlighter-rouge">InitSession</code> ou <code class="language-plaintext highlighter-rouge">EndSession</code>, o checkout devolve a mensagem de resposta ao POS e não fecha o socket. A responsabilidade de fechar o socket de comunicação é do POS.
    <ul>
      <li>Depois de enviar a resposta do <code class="language-plaintext highlighter-rouge">EndSession</code>, o checkout deve esperar o POS desconectar o socket. Se isso não acontecer em até 10 (dez) segundos, então o checkout deverá fechar o socket para encerrar o processo.</li>
    </ul>
  </li>
  <li>O POS poderá, opcionalmente, desconectar o socket entre o <code class="language-plaintext highlighter-rouge">InitSession</code> e o <code class="language-plaintext highlighter-rouge">EndSession</code>. Se o checkout detectar uma desconexão enquanto aguarda uma mensagem do POS, ele deve voltar a aguardar a conexão do POS sem gerar nenhum tipo de erro.</li>
</ul>

<p>O fluxograma a seguir detalha o processo de comunicação a ser efetuado pelo checkout imediatamente após o operador solicitar pagamento usando a Cielo:</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.007.png" alt="" /></p>

<h2 id="situações-de-exceção">Situações de exceção</h2>

<p>Esta sessão ilustra o comportamento esperado dos sistemas POS e checkout em situações de exceção.</p>

<h3 id="transação-negada">Transação negada</h3>

<p>O diagrama a seguir mostra a situação em que a transação financeira não é aprovada na rede Cielo.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.008.png" alt="" /></p>

<p>A Cielo nega a transação (1). O POS envia um comando para finalizar a sessão, indicando que a transação foi negada (2) com a mensagem <strong>“SALDO INSUFICIENTE”</strong>.</p>

<p><strong>Exemplo de Fluxo</strong></p>

<ol>
  <li>
    <p>A Cielo nega a transação.</p>
  </li>
  <li>
    <p>O POS envia um comando para finalizar a sessão, indicando que a transação foi negada com a mensagem <strong>“SALDO INSUFICIENTE”</strong>:</p>
  </li>
</ol>

<p><strong>POS</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdEndSession"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pos_sn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"987264BY3463-23"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SALDO INSUFICIENTE"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O checkout recebe a informação de negação e fecha a sessão com sucesso:</p>

<p>AC ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RspEndSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="checkout-ocupado">Checkout ocupado</h3>

<p>O diagrama a seguir mostra uma situação em que o checkout está ocupada atendendo um outro POS.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.009.png" alt="" /></p>

<p><strong>O POS envia um comando para iniciar uma sessão:</strong></p>

<p><strong>POS</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdInitSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43567484"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O checkout não aceita a conexão, informando que está com uma sessão aberta com outro terminal.</p>

<p><strong>AC</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RspInitSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43567484"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="não-foi-possível-conectar-o-checkout">Não foi possível conectar o checkout</h3>

<p>O diagrama a seguir ilustra a situação em que a transação é efetuada com sucesso na rede Cielo, maso POS não consegue a conexão socket para finalizar a sessão com o checkout. Esta situação pode ocorrer com facilidade se o operador cancelar o processo.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.010.png" alt="" /></p>

<p>Se o POS não conseguir conexão socket com o checkout em 5 (cinco) segundos, ele deve desfazer a transação com a rede Cielo.</p>

<h3 id="erro-no-procedimento-fiscal">Erro no procedimento fiscal</h3>

<p>O diagrama a seguir mostra a situação em que a transação financeira é aprovada na rede Cielo, mas o checkout não consegue efetuar os procedimentos fiscais e decide cancelar o pagamento.</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.011.png" alt="" /></p>

<p>A rede Cielo aprova a transação (1) e o POS envia um comando para finalizar a sessão, indicando sucesso (2).</p>

<p><strong>POS</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CmdEndSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_sn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"987264BY3463-23"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"transaction"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"amount"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12580"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prod_pri"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prod_sec"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w">
        </span><span class="nl">"nsu"</span><span class="p">:</span><span class="w"> </span><span class="s2">"987654"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"aut"</span><span class="p">:</span><span class="w"> </span><span class="s2">"901782"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"installments"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-11-29T15:02:18"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"receipt_gen"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="err">Conjunto</span><span class="w"> </span><span class="err">de</span><span class="w"> </span><span class="err">strings</span><span class="w"> </span><span class="err">correspondente</span><span class="w"> </span><span class="err">ao</span><span class="w"> </span><span class="err">comprovante</span><span class="w"> </span><span class="err">genérico</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_cli"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="err">Conjunto</span><span class="w"> </span><span class="err">de</span><span class="w"> </span><span class="err">strings</span><span class="w"> </span><span class="err">correspondente</span><span class="w"> </span><span class="err">ao</span><span class="w"> </span><span class="err">comprovante</span><span class="w"> </span><span class="err">do</span><span class="w"> </span><span class="err">cliente</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_cli_sm"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="err">Conjunto</span><span class="w"> </span><span class="err">de</span><span class="w"> </span><span class="err">strings</span><span class="w"> </span><span class="err">correspondente</span><span class="w"> </span><span class="err">ao</span><span class="w"> </span><span class="err">comprovante</span><span class="w"> </span><span class="err">reduzido</span><span class="w"> </span><span class="err">do</span><span class="w"> </span><span class="err">cliente</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"receipt_mch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="err">//</span><span class="w"> </span><span class="err">Conjunto</span><span class="w"> </span><span class="err">de</span><span class="w"> </span><span class="err">strings</span><span class="w"> </span><span class="err">correspondente</span><span class="w"> </span><span class="err">ao</span><span class="w"> </span><span class="err">comprovante</span><span class="w"> </span><span class="err">do</span><span class="w"> </span><span class="err">lojista</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O checkout recebe os dados da transação, mas não consegue efetuar os procedimentos fiscais e retorna indicação de erro para o POS (3).</p>

<p><strong>AC</strong> ➡️</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RspEndSession"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pos_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"91746241"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_pos"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00018725"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seq_ac"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00000098"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>O POS desfaz a transação na rede Cielo (4).</p>

<h1 id="implementação-alternativa-simbiose">Implementação Alternativa (SIMBIOSE)</h1>

<p>Existe um padrão antigo de mercado para comunicação entre sistemas de checkout e sistemas de pagamento usando troca de arquivos especificado pelo documento TEF_DIAL. Apesar de ser um padrão bem antigo, ele ainda é suportado por diversos sistemas de checkout do mercado brasileiro.</p>

<p>Para facilitar a integração com esses sistemas existentes, a Cielo fornece uma aplicação denominada <strong>“SIMBIOSE”</strong> capaz de emular essa troca de arquivos e implementar a comunicação com o POS usando o protocolo JSON especificado neste documento.</p>

<p>Este formato organiza a informação de forma clara e acessível, destacando a aplicação SIMBIOSE</p>

<p><img src="https://desenvolvedores.cielo.com.br/api-portal/sites/default/files/images/Aspose.Words.5106fbda-7c74-4c82-a3a3-e0d058563a95.012.png" alt="" /></p>

<p>O “SIMBIOSE” implementa o esquema especificado no documento TEF_DIAL com as seguintes diferenças:</p>

<p>Somente os seguintes tipos de operação estão implementados:</p>

<table>
  <thead>
    <tr>
      <th><strong>Operação</strong></th>
      <th><strong>Descrição</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>“ATV”</td>
      <td>Verifica se o SIMBIOSE está ativo.</td>
    </tr>
    <tr>
      <td>“CRT”</td>
      <td>Pedido de autorização para transação por meio de cartão.</td>
    </tr>
    <tr>
      <td>“CNF”</td>
      <td>Confirmação da venda e realização dos processos fiscais.</td>
    </tr>
    <tr>
      <td>“NCN”</td>
      <td>Não confirmação da venda e/ou realização dos processos fiscais.</td>
    </tr>
  </tbody>
</table>

<p>Os seguintes campos foram criados para implementar os diferentes tipos e vias de comprovante:</p>

<table>
  <thead>
    <tr>
      <th><strong>Campo</strong></th>
      <th><strong>Descrição</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>028-000</td>
      <td>Quantidade de linhas do comprovante genérico (“.receipt_gen”).</td>
    </tr>
    <tr>
      <td>029-xxx</td>
      <td>Cada uma das linhas do comprovante genérico (“.receipt_gen”), sendo xxx &gt;= “001”.</td>
    </tr>
    <tr>
      <td>710-000</td>
      <td>Quantidade de linhas do comprovante reduzido (“.receipt_cli_sm”).</td>
    </tr>
    <tr>
      <td>711-xxx</td>
      <td>Cada uma das linhas do comprovante reduzido (“.receipt_cli_sm”), sendo xxx &gt;= “001”.</td>
    </tr>
    <tr>
      <td>712-000</td>
      <td>Quantidade de linhas da via do cliente (“.receipt_cli”).</td>
    </tr>
    <tr>
      <td>713-xxx</td>
      <td>Cada uma das linhas da via do cliente (“.receipt_cli”), sendo xxx &gt;= “001”.</td>
    </tr>
    <tr>
      <td>714-000</td>
      <td>Quantidade de linhas da via do estabelecimento (“.receipt_mch”).</td>
    </tr>
    <tr>
      <td>715-xxx</td>
      <td>Cada uma das linhas da via do estabelecimento (“.receipt_mch”), sendo xxx &gt;= “001”.</td>
    </tr>
  </tbody>
</table>
</div>


            <div class="footer-conteudo">
  <div id="footer-conteudo-img" class="col-lg-1 col-md-1">
    <img
      src="https://developercielo.github.io/assets/images/icon-doubt.svg"
      width="55px"
      height="53px"
      alt="Precisa de ajuda?"
    />
  </div>

  <div id="footer-conteudo-texto" class="col-lg-11 col-md-11">
    <h2>Precisa de ajuda?</h2>
    <p>Se você não conseguiu encontrar sua resposta acima, <a href="https://devcielo.zendesk.com/hc/pt-br#suporte">entre em contato conosco</a>.</p>
  </div>
</div>

        </div>

        <div class="sidebar">
  <div class="sidebar-sticky">
    <div class="sidebar-about">
      <a
        title="Comutar a coluna da esquerda"
        class="hamburger"
      >
        <i class="fa fa-bars hamb-menu" aria-hidden="true"></i>
      </a>
      <a href="https://desenvolvedores.cielo.com.br" target="_blank">
        <img
          src="https://developercielo.github.io/assets/images/logo.png"
          alt="Documentações e tutoriais"
          style="width: 60%; margin-left: 20%"
        />
      </a>
      <div></div>
    </div>

    <div id="toc"></div>

    <div class="fixed-footer">
      

      <div class="toc-contact">
        <div class="contact">
          <a
            title="Contato"
            href="https://devcielo.zendesk.com/"
          >
            <i class="fa fa-envelope-o" aria-hidden="true"></i>
            <span>Contato</span>
          </a>
        </div>
        <div class="github">
          <a title="GitHub" href="https://github.com/developercielo">
            <i class="fa fa-github" aria-hidden="true"></i>
            <span>GitHub</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>


        <script src="https://developercielo.github.io/assets/bundles/js/bundle.min.js"></script>
        <script>
            
            var selectors = 'h1,h2,h3,h4,h5,h6';
            
        </script>

        
        <script src="https://developercielo.github.io/assets/bundles/js/search.min.js"></script>
        

        
        <script>
            let langs = '';
            let langsArray = [];

            
            langs += "<a data-language-name='shell'>cURL</a>";
            langsArray.push('shell');
            

            var toggleCode = 'Comutar';
        </script>

        <script src='https://developercielo.github.io/assets/bundles/js/language_buttons.min.js'></script>
        

        <!-- Hotjar Tracking Code for https://developercielo.github.io/ -->
<script>
  (function (h, o, t, j, a, r) {
    h.hj =
      h.hj ||
      function () {
        (h.hj.q = h.hj.q || []).push(arguments);
      };
    h._hjSettings = { hjid: 674586, hjsv: 6 };
    a = o.getElementsByTagName("head")[0];
    r = o.createElement("script");
    r.async = 1;
    r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
    a.appendChild(r);
  })(window, document, "https://static.hotjar.com/c/hotjar-", ".js?sv=");
</script>

    </body>
</html>
